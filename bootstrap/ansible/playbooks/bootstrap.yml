---
- name: Setup local environment to start repository usage
  hosts: localhost
  connection: local

  vars:
    kubectl_version: 1.17.0
    minikube_version: 1.6.1
    k9s_version: 0.7.11
    kube_forwarder_version: 1.2.0
    kind_version: 0.6.1
    kubespy_version: 0.5.0
    linters: ["shellcheck", "yamllint", "pylint3"]
    terraform_version: 0.12.20
    tflint_version: 0.14.0
    helm_version: 3.0.3
  tasks:

    - name: Install helm {{ helm_version }}
      unarchive:
        src: https://get.helm.sh/helm-v{{ helm_version }}-linux-amd64.tar.gz
        dest: /usr/local/bin
        mode: 0755
        remote_src: true
        extra_opts:
          - --strip-components=1
      become: true

    - name: Install tflint {{ tflint_version }}
      unarchive:
        src: https://github.com/terraform-linters/tflint/releases/download/v{{ tflint_version }}/tflint_linux_amd64.zip
        dest: /usr/local/bin
        mode: 0755
        remote_src: true
      become: true

    - name: Install terraform {{ terraform_version }}
      unarchive:
        src: https://releases.hashicorp.com/terraform/{{ terraform_version }}/terraform_{{ terraform_version }}_linux_amd64.zip
        dest: /usr/local/bin
        mode: 0755
        remote_src: true
      become: true

    - name: Install linter packages
      package:
        name: "{{ linters }}"
      become: true

    # yamllint disable rule:line-length
    - name: Download and install kubespy {{ kubespy_version }}
      unarchive:
        src: https://github.com/pulumi/kubespy/releases/download/v{{ kubespy_version }}/kubespy-linux-amd64.tar.gz
        dest: /usr/local/bin
        mode: 0755
        remote_src: true
        extra_opts:
          - --strip-components=2
      become: true

    - name: Download and install kubectl {{ kubectl_version }}
      get_url:
        url: https://storage.googleapis.com/kubernetes-release/release/v{{ kubectl_version }}/bin/linux/amd64/kubectl
        dest: /usr/local/bin/
        mode: 0755
      become: true

    - name: Download and install minikube {{ minikube_version }}
      get_url:
        url: https://storage.googleapis.com/minikube/releases/v{{ minikube_version }}/minikube-linux-amd64
        dest: /usr/local/bin/
        mode: 0755
      become: true

    - name: Download and install k9s {{ k9s_version }}
      unarchive:
        src: https://github.com/derailed/k9s/releases/download/{{ k9s_version }}/k9s_{{ k9s_version }}_Linux_x86_64.tar.gz
        dest: /usr/local/bin
        mode: 0755
        remote_src: true
      become: true

    - name: Download and install kube forwarder {{ kube_forwarder_version }}
      get_url:
        url: https://github.com/pixel-point/kube-forwarder/releases/download/v{{ kube_forwarder_version }}/kube-forwarder.AppImage
        dest: /usr/local/bin/kube-forwarder
        mode: 0755
      become: true

    - name: Download and install kind {{ kind_version }}
      get_url:
        url: https://github.com/kubernetes-sigs/kind/releases/download/v{{ kind_version }}/kind-linux-amd64
        dest: /usr/local/bin/kind
        mode: 0755
      become: true
